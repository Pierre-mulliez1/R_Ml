---
title: "EDA_markdown"
author: "Pierre Mulliez"
date: "26/06/2021"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
######LOAD AND INSPECT FILES######
library(ggplot2)
library(data.table)  
library(fBasics)
library(dplyr)
library(leaflet)
library(readxl)

#uniform way to get file
getwd()
dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
##setwd(dir)

path_train = "data/train.csv"
path_location = "data/country_location.xlsx"
data = read.csv(path_train)
data2 = data
dat2 = read_xlsx(path_location)
dat2 = data.frame(dat2)
tail(data)
summary(data)
```


<h2 style="color: blue; text-align:center";>  Some static visualization </h2>

```{r time_serie,  echo=FALSE}
#######Visualisation#######


"different countries :"
head(unique(data["Country_Region"]))
"Number of different countries: "
count(unique(data["Country_Region"]))
"What years are in the dataset: " 
unique(year(data2$Date))

#Preparation for maps - get country location and group by country
#the merge will remove some value - do not use the table in ML
last_date <- data %>% group_by(Country_Region)%>% summarise(Fatalities = sum(Fatalities),Cases = sum(ConfirmedCases))
last_date_merged <- merge(x = last_date,y = dat2,by.x = "Country_Region", by.y = "name",all = FALSE)
  
last_date_merged$size <- 10000
last_date_merged[last_date_merged$Cases > 5000,]$size <-  80000
last_date_merged[last_date_merged$Cases > 10000,]$size <-  150000

last_date_merged$col <- "blue"
last_date_merged[last_date_merged$Fatalities > 2000,]$col <-  "darkblue"
last_date_merged[last_date_merged$Fatalities > 10000,]$col <-  "red"


last_date_merged$countryC <- paste("country", ", Cases: " ,toString(0))
for (country in last_date_merged$Country_Region){
  (last_date_merged[last_date_merged$Country_Region == country,]$countryC
   <- paste(country, ", Cases: " ,toString(last_date_merged[last_date_merged$Country_Region == country,]$Cases)))
}

```

<h2 style="color: blue; text-align:center";> Embedded shiny app </h2>


```{r shiny, echo=FALSE}
#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)
library(data.table)

# Define UI for application that draws a histogram
ui <- fluidPage(  
    title = 'Covid Analysis',
    
    
    mainPanel(
        img(src='www/covid.png', align = "right", height = 20, width = 20),
        tags$head(
            tags$style(type='text/css',
                       ".nav-tabs {font-size: 25px; background-color: skyblue} ")),
        tabsetPanel(
            type = "tabs",

            tabPanel("Plot", 
                     
                     # Multiple response choice; you can choose many countries
                     selectInput("selected_country", label = h3("Country to Plot"),
                                 choices = c("",c("",unique(last_date_merged$Country_Region))),
                                 selected = "France",
                                 width='55%',
                                 multiple = TRUE),
                     
                     
                     fluidRow(
                         column(12, leafletOutput("mymap"), p(), actionButton("recalc", "New points"))
                     )
                     
                     
            ),
            
            tabPanel("Time series", 
                     
                     # Single response choice
                     selectInput("selected_column_plot", label = h3("Column to Plot"),
                                 choices = c("","Fatalities","ConfirmedCases"),
                                 selected = "ConfirmedCases",
                                 width='55%',
                                 multiple = FALSE),
                     
                     fluidRow(
                         column(12, plotOutput("ts_plot"))
                     ),
                      verbatimTextOutput("summary")
                     
            )
   
            
        )
    )
)


# Define server logic required to draw a histogram
server <- function(input, output){
    
    ### Reactive functions
  
    #compose dataset for country mapping
     national_covid <-   reactive({
      last_date_merged  %>% filter(Country_Region %in% input$selected_country )}
      )
    
    ### Plots
    compute_plot <- reactive({
           
       #test
      print(national_covid())
      
     
      #compose map
      cov_map <- (leaflet(data = national_covid()) %>% addTiles() 
                  %>% addCircles( lng = ~longitude, lat = ~latitude,popup = ~countryC, color = ~col, radius = ~size,fill = F))
      cov_map <-  addLegend(cov_map,"bottomright", 
                  labels = c("<2000","2000+","10000+"), 
                  colors = c("blue","darkblue","red"),
                  title = "Fatalities",
                  opacity = 1) 
      cov_map
    })
    
    #generate country map plot
    output$mymap <- renderLeaflet({
        compute_plot();
    })
    
    #compose dataset for time serie
     global_covid <-   reactive({
        if (input$selected_column_plot == "Fatalities"){
      data.frame(data2) %>%  group_by(grouped_date = month(Date)) %>% summarise(occurence=sum(Fatalities))}
       else {
           data.frame(data2) %>%  group_by(grouped_date = month(Date)) %>% summarise(occurence=sum(ConfirmedCases))
       }})
     
 ### compose time serie Plot
    compute_times <- reactive({
        if (input$selected_column_plot != ""){
          dataset <- global_covid()
           ggplot(dataset, aes(x = grouped_date, y=occurence)) + geom_line(color = "red",size=2) +  theme(text = element_text(size=20)) +  theme_dark()
        }
    })
 
    #generate time serie plot
    output$ts_plot <- renderPlot({
        compute_times();
    })
    
    
     #generate summary
      output$summary <- renderPrint({
      dataset <- global_covid()
      summary(dataset$occurence)
    })

    
}

# Run the application 
shinyApp(ui = ui, server = server)
```


